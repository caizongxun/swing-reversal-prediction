#!/usr/bin/env python3\n\"\"\"\nColab脚本: 从HuggingFace Datasets抓取K线数据\n功能: 自动下载、合并和分析Binance US K线数据\n数据来源: https://huggingface.co/datasets/zongowo111/cpb-models/tree/main/klines_binance_us\n\"\"\"\n\nimport os\nimport json\nimport pandas as pd\nimport requests\nfrom pathlib import Path\nimport subprocess\nimport sys\n\n# HuggingFace数据集配置\nHF_DATASET_OWNER = \"zongowo111\"\nHF_DATASET_NAME = \"cpb-models\"\nHF_REPO_TYPE = \"dataset\"\nHF_DATA_PATH = \"klines_binance_us\"\n\n# 支持的交易对\nTRADING_PAIRS = [\n    \"BTCUSDT\",\n    \"ETHUSDT\",\n    \"BNBUSDT\",\n    \"SOLUSDT\",\n    \"XRPUSDT\",\n    \"ADAUSDT\",\n    \"DOGEUSDT\",\n    \"MATICUSDT\",\n    \"AVAXUSDT\",\n    \"LINKUSDT\",\n    \"LTCUSDT\",\n    \"UNIUSDT\",\n    \"BCHUSDT\",\n    \"ETCUSDT\",\n    \"XLUSDT\",\n    \"DOTUSDT\",\n    \"TRXUSDT\"\n]\n\n# 支持的时间周期\nTIMEFRAMES = [\"15m\", \"1h\"]\n\n\nclass HuggingFaceKlinesDownloader:\n    \"\"\"从HuggingFace Datasets下载K线数据的类\"\"\"\n    \n    def __init__(self):\n        self.hf_dataset = f\"{HF_DATASET_OWNER}/{HF_DATASET_NAME}\"\n        self.data_path = HF_DATA_PATH\n        self.output_dir = \"downloaded_klines\"\n        Path(self.output_dir).mkdir(exist_ok=True)\n    \n    def install_dependencies(self):\n        \"\"\"安装必需的依赖\"\"\"\n        print(\"安装必需的库...\")\n        packages = [\"datasets\", \"huggingface-hub\", \"pandas\", \"numpy\"]\n        for package in packages:\n            subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-q\", package])\n        print(\"依赖安装完成\")\n    \n    def download_klines_from_hf(self, trading_pair, timeframe=\"15m\"):\n        \"\"\"从HuggingFace下载指定交易对的K线数据\n        \n        Args:\n            trading_pair: 交易对，例如 \"BTCUSDT\"\n            timeframe: 时间周期，\"15m\" 或 \"1h\"\n            \n        Returns:\n            DataFrame: K线数据\n        \"\"\"\n        try:\n            print(f\"下载 {trading_pair} {timeframe} K线数据...\")\n            \n            # 使用HuggingFace Hub直接下载\n            from huggingface_hub import hf_hub_download\n            \n            # 构建文件路径\n            file_name = f\"{trading_pair}_{timeframe}.csv\"\n            repo_id = f\"{HF_DATASET_OWNER}/{HF_DATASET_NAME}\"\n            \n            try:\n                # 尝试下载CSV文件\n                file_path = hf_hub_download(\n                    repo_id=repo_id,\n                    filename=f\"{HF_DATA_PATH}/{file_name}\",\n                    repo_type=HF_REPO_TYPE\n                )\n                \n                # 读取CSV\n                df = pd.read_csv(file_path)\n                print(f\"成功下载 {trading_pair} {timeframe}: {len(df)} 行数据\")\n                return df\n                \n            except Exception as e:\n                print(f\"直接下载失败: {e}\")\n                print(f\"尝试使用datasets库...\")\n                \n                # 备选方法：使用datasets库\n                from datasets import load_dataset\n                dataset = load_dataset(f\"{HF_DATASET_OWNER}/cpb-models\", split=\"train\")\n                \n                # 过滤指定的交易对和时间周期\n                filtered = dataset.filter(\n                    lambda x: x.get(\"pair\") == trading_pair and x.get(\"timeframe\") == timeframe\n                )\n                \n                if len(filtered) > 0:\n                    df = filtered.to_pandas()\n                    print(f\"成功加载 {trading_pair} {timeframe}: {len(df)} 行数据\")\n                    return df\n                else:\n                    return None\n                    \n        except Exception as e:\n            print(f\"下载 {trading_pair} {timeframe} 失败: {e}\")\n            return None\n    \n    def fetch_and_combine(self, trading_pair, timeframe=\"15m\", rows=10000):\n        \"\"\"获取并整合K线数据\n        \n        Args:\n            trading_pair: 交易对\n            timeframe: 时间周期\n            rows: 返回的行数\n            \n        Returns:\n            DataFrame: 整合后的K线数据\n        \"\"\"\n        df = self.download_klines_from_hf(trading_pair, timeframe)\n        \n        if df is not None:\n            # 确保列名正确\n            required_columns = [\"timestamp\", \"open\", \"high\", \"low\", \"close\", \"volume\"]\n            \n            # 检查列名\n            if all(col in df.columns for col in required_columns):\n                # 保留必需列\n                df = df[required_columns]\n            elif all(col.lower() in [c.lower() for c in df.columns] for col in required_columns):\n                # 列名不区分大小写，重新命名\n                rename_dict = {}\n                for col in df.columns:\n                    for req_col in required_columns:\n                        if col.lower() == req_col.lower():\n                            rename_dict[col] = req_col\n                df = df.rename(columns=rename_dict)\n                df = df[required_columns]\n            else:\n                print(f\"警告: 数据格式不符。现有列: {df.columns.tolist()}\")\n                return None\n            \n            # 取最后N行（最新的数据）\n            df = df.tail(rows).reset_index(drop=True)\n            \n            # 确保timestamp是字符串格式\n            df[\"timestamp\"] = df[\"timestamp\"].astype(str)\n            \n            # 保存到本地\n            output_file = f\"{self.output_dir}/{trading_pair}_{timeframe}_{rows}.csv\"\n            df.to_csv(output_file, index=False)\n            print(f\"已保存到: {output_file}\")\n            \n            return df\n        else:\n            return None\n    \n    def list_available_data(self):\n        \"\"\"列出HuggingFace上可用的数据\"\"\"\n        print(\"可用的数据列表:\")\n        print(\"交易对列表:\")\n        for pair in TRADING_PAIRS:\n            print(f\"  - {pair}\")\n        print(\"\\n支持的时间周期:\")\n        for tf in TIMEFRAMES:\n            print(f\"  - {tf}\")\n        \n        print(f\"\\n数据来源: https://huggingface.co/datasets/{self.hf_dataset}/tree/main/{self.data_path}\")\n\n\ndef main():\n    \"\"\"主函数：执行数据下载流程\"\"\"\n    \n    print(\"=\"*60)\n    print(\"HuggingFace K线数据下载工具\")\n    print(\"=\"*60)\n    \n    # 初始化下载器\n    downloader = HuggingFaceKlinesDownloader()\n    \n    # 安装依赖\n    downloader.install_dependencies()\n    \n    # 列出可用数据\n    downloader.list_available_data()\n    \n    # 下载示例数据\n    print(\"\\n\")\n    print(\"开始下载K线数据...\")\n    print(\"=\"*60)\n    \n    # 下载BTC USDT 15分钟数据\n    df_btc = downloader.fetch_and_combine(\n        trading_pair=\"BTCUSDT\",\n        timeframe=\"15m\",\n        rows=10000\n    )\n    \n    if df_btc is not None:\n        print(f\"\\nBTC USDT 数据统计:\")\n        print(f\"  行数: {len(df_btc)}\")\n        print(f\"  列数: {len(df_btc.columns)}\")\n        print(f\"  日期范围: {df_btc['timestamp'].iloc[0]} 到 {df_btc['timestamp'].iloc[-1]}\")\n        print(f\"\\n前5行数据:\")\n        print(df_btc.head())\n        print(f\"\\n数据已保存，可以用于后续分析\")\n    \n    return df_btc\n\n\nif __name__ == \"__main__\":\n    df = main()\n