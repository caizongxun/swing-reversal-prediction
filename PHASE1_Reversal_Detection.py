#!/usr/bin/env python3\n\"\"\"\nPHASE1: Swing Reversal Point Detection & Labeling\n\n功能：\n1. 从下载的 K 线数据识别所有有效的反转点\n2. 分类反转类型（波段支撑、波段压力、趋势起始、趋势终点）\n3. 输出标记化数据集用于模型训练\n\n反转点定义：\n- 波段反转：在支撑区反弹或压力区回落\n- 趋势反转：趋势方向改变，通常伴随动能信号\n\n\"\"\"\n\nimport numpy as np\nimport pandas as pd\nfrom sklearn.cluster import KMeans\nfrom sklearn.preprocessing import StandardScaler\nimport warnings\nwarnings.filterwarnings('ignore')\n\n\nclass ReversalDetector:\n    \"\"\"反转点检测引擎\"\"\"\n    \n    def __init__(self, df, lookback=20, reversal_window=5):\n        \"\"\"\n        初始化反转检测器\n        \n        Args:\n            df: DataFrame，包含 timestamp, open, high, low, close, volume\n            lookback: 用于计算支撑压力的回看窗口\n            reversal_window: 用于确认反转的窗口（前后各N根）\n        \"\"\"\n        self.df = df.copy()\n        self.lookback = lookback\n        self.reversal_window = reversal_window\n        self.reversals = []\n        \n    def calculate_technical_indicators(self):\n        \"\"\"计算技术指标\"\"\"\n        # 移动平均线\n        self.df['SMA20'] = self.df['close'].rolling(20).mean()\n        self.df['SMA50'] = self.df['close'].rolling(50).mean()\n        self.df['SMA200'] = self.df['close'].rolling(200).mean()\n        \n        # RSI (Relative Strength Index)\n        delta = self.df['close'].diff()\n        gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()\n        loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()\n        rs = gain / loss\n        self.df['RSI'] = 100 - (100 / (1 + rs))\n        \n        # MACD\n        exp1 = self.df['close'].ewm(span=12, adjust=False).mean()\n        exp2 = self.df['close'].ewm(span=26, adjust=False).mean()\n        self.df['MACD'] = exp1 - exp2\n        self.df['Signal'] = self.df['MACD'].ewm(span=9, adjust=False).mean()\n        self.df['MACD_Hist'] = self.df['MACD'] - self.df['Signal']\n        \n        # 布林带 (Bollinger Bands)\n        sma = self.df['close'].rolling(20).mean()\n        std = self.df['close'].rolling(20).std()\n        self.df['BB_Upper'] = sma + 2 * std\n        self.df['BB_Lower'] = sma - 2 * std\n        self.df['BB_Pct'] = (self.df['close'] - self.df['BB_Lower']) / (self.df['BB_Upper'] - self.df['BB_Lower'])\n        \n        # 支撑压力 (Support/Resistance)\n        self.df['Support'] = self.df['low'].rolling(self.lookback).min()\n        self.df['Resistance'] = self.df['high'].rolling(self.lookback).max()\n        \n        # 成交量 Z-score\n        vol_sma = self.df['volume'].rolling(20).mean()\n        vol_std = self.df['volume'].rolling(20).std()\n        self.df['Volume_Z'] = (self.df['volume'] - vol_sma) / vol_std\n        \n        # 价格变化率\n        self.df['ROC'] = (self.df['close'] - self.df['close'].shift(5)) / self.df['close'].shift(5) * 100\n        \n    def detect_regime(self):\n        \"\"\"检测市场制度（趋势 vs 波段）\"\"\"\n        # 用 SMA 200 判断趋势\n        self.df['Above_SMA200'] = self.df['close'] > self.df['SMA200']\n        \n        # 计算 ATR (Average True Range) 衡量波动性\n        tr = pd.concat([\n            self.df['high'] - self.df['low'],\n            abs(self.df['high'] - self.df['close'].shift()),\n            abs(self.df['low'] - self.df['close'].shift())\n        ], axis=1).max(axis=1)\n        self.df['ATR'] = tr.rolling(14).mean()\n        \n        # 波动率（ATR / SMA）\n        self.df['Volatility_Ratio'] = self.df['ATR'] / self.df['SMA20']\n        \n        # 简单的趋势判定：用 SMA 斜率\n        sma20_slope = (self.df['SMA20'] - self.df['SMA20'].shift(5)) / self.df['SMA20'].shift(5) * 100\n        self.df['Trend_Slope'] = sma20_slope\n        \n        # 判定：如果 SMA 斜率 > 1%，趋势向上；< -1%，趋势向下；否则波段\n        self.df['Regime'] = 'Range'\n        self.df.loc[self.df['Trend_Slope'] > 1.0, 'Regime'] = 'Uptrend'\n        self.df.loc[self.df['Trend_Slope'] < -1.0, 'Regime'] = 'Downtrend'\n        \n    def detect_range_reversals(self):\n        \"\"\"检测波段盘反转点\"\"\"\n        range_reversals = []\n        \n        for i in range(self.reversal_window, len(self.df) - self.reversal_window):\n            current = self.df.iloc[i]\n            \n            # 跳过无效数据\n            if pd.isna(current['BB_Lower']) or pd.isna(current['RSI']):\n                continue\n            \n            # 支撑反转信号：\n            # 1. 价格接近或触及下布林带\n            # 2. RSI 过度卖出 (< 30)\n            # 3. 之后几根 K 线上升\n            if (current['BB_Pct'] < 0.2 and current['RSI'] < 40):\n                # 检查之后是否反弹\n                future_high = self.df.iloc[i:i+self.reversal_window+1]['high'].max()\n                if future_high > current['close'] * 1.002:  # 至少上升 0.2%\n                    range_reversals.append({\n                        'index': i,\n                        'timestamp': current['timestamp'],\n                        'price': current['close'],\n                        'type': 'Support',\n                        'regime': 'Range',\n                        'rsi': current['RSI'],\n                        'bb_pct': current['BB_Pct'],\n                        'confirmation': 'Bounce'\n                    })\n            \n            # 压力反转信号：\n            # 1. 价格接近或触及上布林带\n            # 2. RSI 过度买入 (> 70)\n            # 3. 之后几根 K 线下降\n            if (current['BB_Pct'] > 0.8 and current['RSI'] > 60):\n                future_low = self.df.iloc[i:i+self.reversal_window+1]['low'].min()\n                if future_low < current['close'] * 0.998:  # 至少下降 0.2%\n                    range_reversals.append({\n                        'index': i,\n                        'timestamp': current['timestamp'],\n                        'price': current['close'],\n                        'type': 'Resistance',\n                        'regime': 'Range',\n                        'rsi': current['RSI'],\n                        'bb_pct': current['BB_Pct'],\n                        'confirmation': 'Pullback'\n                    })\n        \n        return range_reversals\n    \n    def detect_trend_reversals(self):\n        \"\"\"检测趋势盘反转点\"\"\"\n        trend_reversals = []\n        \n        for i in range(self.reversal_window * 2, len(self.df) - self.reversal_window):\n            current = self.df.iloc[i]\n            \n            # 跳过无效数据\n            if pd.isna(current['MACD_Hist']) or pd.isna(current['Volume_Z']):\n                continue\n            \n            # 趋势起点信号：\n            # 1. 价格从支撑反弹或压力回落\n            # 2. 成交量爆增 (Volume_Z > 2.0)\n            # 3. MACD 直方图转正或转负\n            \n            # 从下升趋势起点：\n            # 之前是下降趋势或盘整，现在要上升\n            if i > 0:\n                prev_regime = self.df.iloc[i-5:i]['Regime'].value_counts().index[0]\n                if prev_regime in ['Downtrend', 'Range']:\n                    # 检查现在是否有上升信号\n                    if (current['MACD_Hist'] > 0 and \n                        self.df.iloc[i-1]['MACD_Hist'] <= 0 and  # MACD 穿越\n                        current['Volume_Z'] > 1.5):\n                        trend_reversals.append({\n                            'index': i,\n                            'timestamp': current['timestamp'],\n                            'price': current['close'],\n                            'type': 'Trend_Start_Up',\n                            'regime': 'Trend',\n                            'signal': 'MACD_Crossover + Volume',\n                            'macd_hist': current['MACD_Hist'],\n                            'volume_z': current['Volume_Z']\n                        })\n                    \n            # 从上升趋势终点：\n            # 现在是上升趋势，但要开始下降\n            if i > 0:\n                curr_regime = self.df.iloc[i-5:i]['Regime'].value_counts().index[0]\n                if curr_regime == 'Uptrend':\n                    # 检查下降信号\n                    if (current['MACD_Hist'] < 0 and \n                        self.df.iloc[i-1]['MACD_Hist'] >= 0 and  # MACD 穿越\n                        current['RSI'] > 50):  # 仍在高位\n                        trend_reversals.append({\n                            'index': i,\n                            'timestamp': current['timestamp'],\n                            'price': current['close'],\n                            'type': 'Trend_End_Down',\n                            'regime': 'Trend',\n                            'signal': 'MACD_Divergence',\n                            'macd_hist': current['MACD_Hist'],\n                            'rsi': current['RSI']\n                        })\n        \n        return trend_reversals\n    \n    def run_detection(self):\n        \"\"\"执行完整的反转点检测流程\"\"\"\n        print(\"[PHASE1] 开始检测反转点...\")\n        print(f\"数据规模: {len(self.df)} 根 K 线\")\n        \n        # 计算指标\n        print(\"\\n[1/4] 计算技术指标...\")\n        self.calculate_technical_indicators()\n        \n        # 检测制度\n        print(\"[2/4] 检测市场制度 (趋势/波段)...\")\n        self.detect_regime()\n        regime_counts = self.df['Regime'].value_counts()\n        print(f\"    趋势盘: {regime_counts.get('Uptrend', 0) + regime_counts.get('Downtrend', 0)} 根\")\n        print(f\"    波段盘: {regime_counts.get('Range', 0)} 根\")\n        \n        # 检测波段反转\n        print(\"\\n[3/4] 检测波段盘反转点...\")\n        range_reversals = self.detect_range_reversals()\n        print(f\"    发现 {len(range_reversals)} 个波段反转点\")\n        if len(range_reversals) > 0:\n            print(f\"      - 支撑反弹: {len([r for r in range_reversals if r['type']=='Support'])}\")\n            print(f\"      - 压力回落: {len([r for r in range_reversals if r['type']=='Resistance'])}\")\n        \n        # 检测趋势反转\n        print(\"\\n[4/4] 检测趋势盘反转点...\")\n        trend_reversals = self.detect_trend_reversals()\n        print(f\"    发现 {len(trend_reversals)} 个趋势反转点\")\n        if len(trend_reversals) > 0:\n            trend_up = len([r for r in trend_reversals if 'Up' in r['type']])\n            trend_down = len([r for r in trend_reversals if 'Down' in r['type']])\n            print(f\"      - 趋势起点 (上): {trend_up}\")\n            print(f\"      - 趋势终点 (下): {trend_down}\")\n        \n        # 合并所有反转点\n        all_reversals = range_reversals + trend_reversals\n        self.reversals = pd.DataFrame(all_reversals).sort_values('index').reset_index(drop=True)\n        \n        return self.reversals\n    \n    def label_dataset(self):\n        \"\"\"为整个数据集标记反转点\"\"\"\n        self.df['Reversal_Label'] = 0  # 默认无反转\n        self.df['Reversal_Type'] = 'None'\n        self.df['Reversal_Strength'] = 0.0\n        \n        for idx, row in self.reversals.iterrows():\n            i = row['index']\n            if i < len(self.df):\n                self.df.at[i, 'Reversal_Label'] = 1\n                self.df.at[i, 'Reversal_Type'] = row['type']\n                \n                # 计算反转强度（0-1）\n                if 'rsi' in row:\n                    strength = abs(row['rsi'] - 50) / 50  # 0-1\n                    self.df.at[i, 'Reversal_Strength'] = min(strength, 1.0)\n        \n        return self.df\n    \n    def save_results(self, output_path='labeled_klines_phase1.csv'):\n        \"\"\"保存结果\"\"\"\n        # 选择要保存的列\n        cols = ['timestamp', 'open', 'high', 'low', 'close', 'volume',\n                'SMA20', 'SMA50', 'SMA200', 'RSI', 'MACD', 'MACD_Hist',\n                'BB_Upper', 'BB_Lower', 'BB_Pct', 'Support', 'Resistance',\n                'Volume_Z', 'Regime', 'Reversal_Label', 'Reversal_Type', 'Reversal_Strength']\n        \n        existing_cols = [c for c in cols if c in self.df.columns]\n        self.df[existing_cols].to_csv(output_path, index=False)\n        print(f\"\\n已保存标记数据集: {output_path}\")\n        \n        return output_path\n\n\ndef main():\n    \"\"\"主函数\"\"\"\n    import os\n    \n    print(\"=\"*70)\n    print(\"PHASE1: 虚拟货币反转点检测与标记\")\n    print(\"=\"*70)\n    \n    # 查找下载的 CSV 文件\n    csv_file = None\n    if os.path.exists('downloaded_klines/BTCUSDT_15m_10000.csv'):\n        csv_file = 'downloaded_klines/BTCUSDT_15m_10000.csv'\n    elif os.path.exists('BTCUSDT_15m_10000.csv'):\n        csv_file = 'BTCUSDT_15m_10000.csv'\n    \n    if csv_file is None:\n        print(\"错误: 未找到 CSV 文件\")\n        print(\"请先运行: python colab_hf_working.py\")\n        return\n    \n    print(f\"\\n加载数据: {csv_file}\")\n    df = pd.read_csv(csv_file)\n    \n    # 确保数据类型正确\n    df['close'] = pd.to_numeric(df['close'])\n    df['volume'] = pd.to_numeric(df['volume'])\n    df['open'] = pd.to_numeric(df['open'])\n    df['high'] = pd.to_numeric(df['high'])\n    df['low'] = pd.to_numeric(df['low'])\n    \n    print(f\"数据形状: {df.shape}\")\n    print(f\"日期范围: {df['timestamp'].iloc[0]} 到 {df['timestamp'].iloc[-1]}\")\n    \n    # 创建检测器\n    detector = ReversalDetector(df, lookback=20, reversal_window=3)\n    \n    # 运行检测\n    reversals = detector.run_detection()\n    \n    # 标记数据集\n    print(f\"\\n标记数据集...\")\n    labeled_df = detector.label_dataset()\n    \n    # 保存结果\n    output_file = detector.save_results('labeled_klines_phase1.csv')\n    \n    # 打印摘要\n    print(\"\\n\")\n    print(\"=\"*70)\n    print(\"检测结果摘要\")\n    print(\"=\"*70)\n    print(f\"总反转点数: {detector.reversals.shape[0]}\")\n    print(f\"\\n类型分布:\")\n    print(detector.reversals['type'].value_counts())\n    \n    # 打印前 10 个反转点\n    print(f\"\\n前 10 个反转点:\")\n    print(detector.reversals[['index', 'timestamp', 'type', 'price']].head(10))\n    \n    print(f\"\\n已保存到: {output_file}\")\n    return labeled_df, reversals\n\n\nif __name__ == '__main__':\n    main()\n