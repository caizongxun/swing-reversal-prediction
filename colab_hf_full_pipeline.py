#!/usr/bin/env python3\n\"\"\"\nColab完整管道脚本: 从HuggingFace下载K线数据，然后执行反轉检测分析\n步骤:\n  1. 从HuggingFace Datasets下载K线数据\n  2. 执行5阶段反轉检测分析\n  3. 导出结果文件\n\"\"\"\n\nimport os\nimport sys\nimport json\nimport pandas as pd\nimport numpy as np\nimport subprocess\nfrom pathlib import Path\nfrom datetime import datetime\n\n# HuggingFace配置\nHF_DATASET = \"zongowo111/cpb-models\"\nHF_DATA_PATH = \"klines_binance_us\"\nHF_TRADING_PAIRS = [\n    \"BTCUSDT\", \"ETHUSDT\", \"BNBUSDT\", \"SOLUSDT\", \"XRPUSDT\",\n    \"ADAUSDT\", \"DOGEUSDT\", \"MATICUSDT\", \"AVAXUSDT\", \"LINKUSDT\"\n]\nHF_TIMEFRAMES = [\"15m\", \"1h\"]\n\n\nclass HFKlinesDownloader:\n    \"\"\"从HuggingFace下载K线数据\"\"\"\n    \n    def __init__(self):\n        self.output_dir = \"downloaded_klines\"\n        Path(self.output_dir).mkdir(exist_ok=True)\n    \n    def install_packages(self):\n        \"\"\"安装必需包\"\"\"\n        print(\"安装依赖库...\")\n        packages = [\"datasets\", \"huggingface-hub\"]\n        for pkg in packages:\n            subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-q\", pkg])\n        print(\"依赖库安装完成\")\n    \n    def download_klines(self, trading_pair, timeframe=\"15m\", rows=10000):\n        \"\"\"从HuggingFace下载指定交易对的K线数据\n        \n        Args:\n            trading_pair: 例如 \"BTCUSDT\"\n            timeframe: \"15m\" 或 \"1h\"\n            rows: 返回行数\n            \n        Returns:\n            DataFrame 或 None\n        \"\"\"\n        try:\n            print(f\"下载 {trading_pair} {timeframe}...\")\n            \n            from huggingface_hub import hf_hub_download\n            \n            file_name = f\"{trading_pair}_{timeframe}.csv\"\n            repo_id = HF_DATASET\n            \n            # 尝试直接下载CSV\n            try:\n                file_path = hf_hub_download(\n                    repo_id=repo_id,\n                    filename=f\"{HF_DATA_PATH}/{file_name}\",\n                    repo_type=\"dataset\"\n                )\n                \n                df = pd.read_csv(file_path)\n                print(f\"成功: {len(df)} 行数据\")\n                \n                # 验证列\n                required_cols = [\"timestamp\", \"open\", \"high\", \"low\", \"close\", \"volume\"]\n                if all(col in df.columns for col in required_cols):\n                    df = df[required_cols]\n                    df = df.tail(rows).reset_index(drop=True)\n                    return df\n                else:\n                    print(f\"列名检查失败。现有列: {df.columns.tolist()}\")\n                    return None\n                    \n            except Exception as e:\n                print(f\"直接下载失败: {e}\")\n                return None\n                \n        except Exception as e:\n            print(f\"下载过程出错: {e}\")\n            return None\n    \n    def interactive_download(self):\n        \"\"\"互动式下载单个交易对数据\"\"\"\n        print(\"\\n可用的交易对:\")\n        for i, pair in enumerate(HF_TRADING_PAIRS, 1):\n            print(f\"  {i}. {pair}\")\n        \n        pair_index = input(f\"\\n选择交易对 (1-{len(HF_TRADING_PAIRS)}, 默认 1): \").strip()\n        pair_index = int(pair_index) if pair_index else 1\n        selected_pair = HF_TRADING_PAIRS[pair_index - 1]\n        \n        print(\"\\n可用的时间周期:\")\n        for i, tf in enumerate(HF_TIMEFRAMES, 1):\n            print(f\"  {i}. {tf}\")\n        \n        tf_index = input(f\"\\n选择时间周期 (1-{len(HF_TIMEFRAMES)}, 默认 1): \").strip()\n        tf_index = int(tf_index) if tf_index else 1\n        selected_tf = HF_TIMEFRAMES[tf_index - 1]\n        \n        rows = input(\"\\n输入K线数量 (默认 10000): \").strip()\n        rows = int(rows) if rows else 10000\n        \n        print(f\"\\n开始下载 {selected_pair} {selected_tf} ({rows}行)...\\n\")\n        return self.download_klines(selected_pair, selected_tf, rows)\n\n\nclass SwingReversalAnalyzer:\n    \"\"\"反轉检测分析器\"\"\"\n    \n    def __init__(self, window=5, future_candles=12, threshold=1.0):\n        self.window = window\n        self.future_candles = future_candles\n        self.threshold = threshold\n    \n    def detect_swings(self, df):\n        \"\"\"检测振幅点\"\"\"\n        print(\"Phase 1: 检测振幅点...\")\n        \n        highs = df[\"high\"].values\n        lows = df[\"low\"].values\n        n = len(df)\n        \n        swing_highs = []\n        swing_lows = []\n        \n        for i in range(self.window, n - self.window):\n            # 检测局部最高点\n            if all(highs[i] > highs[j] for j in range(i - self.window, i + self.window + 1) if j != i):\n                swing_highs.append(i)\n            \n            # 检测局部最低点\n            if all(lows[i] < lows[j] for j in range(i - self.window, i + self.window + 1) if j != i):\n                swing_lows.append(i)\n        \n        print(f\"  检测到 {len(swing_highs)} 个局部最高点\")\n        print(f\"  检测到 {len(swing_lows)} 个局部最低点\")\n        \n        return swing_highs, swing_lows\n    \n    def confirm_reversals(self, df, swing_highs, swing_lows):\n        \"\"\"验证反轉\"\"\"\n        print(\"\\nPhase 2: 验证反轉...\")\n        \n        confirmed = []\n        closes = df[\"close\"].values\n        \n        # 验证高点反轉\n        for idx in swing_highs:\n            if idx + self.future_candles < len(df):\n                future_min = closes[idx + 1 : idx + self.future_candles + 1].min()\n                change_pct = (closes[idx] - future_min) / closes[idx] * 100\n                \n                if change_pct >= self.threshold:\n                    confirmed.append((idx, \"HIGH\", change_pct))\n        \n        # 验证低点反轉\n        for idx in swing_lows:\n            if idx + self.future_candles < len(df):\n                future_max = closes[idx + 1 : idx + self.future_candles + 1].max()\n                change_pct = (future_max - closes[idx]) / closes[idx] * 100\n                \n                if change_pct >= self.threshold:\n                    confirmed.append((idx, \"LOW\", change_pct))\n        \n        print(f\"  确认 {len(confirmed)} 个反轉点\")\n        return confirmed\n    \n    def extract_features(self, df, indices, window=20):\n        \"\"\"提取特征\"\"\"\n        print(\"\\nPhase 3: 提取特征...\")\n        \n        features_list = []\n        \n        for idx, reversal_type, move_pct in indices:\n            if idx >= window:\n                window_df = df.iloc[idx - window : idx]\n                \n                features = {\n                    \"index\": idx,\n                    \"type\": reversal_type,\n                    \"move_pct\": move_pct,\n                    \"volume_ratio\": window_df[\"volume\"].iloc[-1] / window_df[\"volume\"].mean(),\n                    \"price_change\": (window_df[\"close\"].iloc[-1] - window_df[\"close\"].iloc[0]) / window_df[\"close\"].iloc[0] * 100,\n                    \"volatility\": window_df[\"close\"].std() / window_df[\"close\"].mean(),\n                }\n                features_list.append(features)\n        \n        print(f\"  提取 {len(features_list)} 组特征\")\n        return pd.DataFrame(features_list) if features_list else None\n    \n    def analyze(self, df, output_prefix=\"reversal\"):\n        \"\"\"完整分析流程\"\"\"\n        print(\"\\n\" + \"=\"*60)\n        print(\"开始反轉检测分析\")\n        print(\"=\"*60)\n        \n        # Phase 1: 检测\n        swing_highs, swing_lows = self.detect_swings(df)\n        \n        # Phase 2: 确认\n        confirmed = self.confirm_reversals(df, swing_highs, swing_lows)\n        \n        if not confirmed:\n            print(\"\\n未检测到符合条件的反轉点\")\n            return None\n        \n        # Phase 3: 提取特征\n        features_df = self.extract_features(df, confirmed)\n        \n        # 导出结果\n        print(\"\\nPhase 4: 导出结果...\")\n        \n        output_file = f\"{output_prefix}_analysis_result.csv\"\n        if features_df is not None:\n            features_df.to_csv(output_file, index=False)\n            print(f\"  已保存特征文件: {output_file}\")\n        \n        # 保存标记数据\n        df_labeled = df.copy()\n        df_labeled[\"reversal_label\"] = 0\n        for idx, rtype, _ in confirmed:\n            df_labeled.loc[idx, \"reversal_label\"] = 1\n        \n        labeled_file = f\"{output_prefix}_labeled_data.csv\"\n        df_labeled.to_csv(labeled_file, index=False)\n        print(f\"  已保存标记数据: {labeled_file}\")\n        \n        print(\"\\n分析完成！\")\n        print(\"=\"*60)\n        \n        return {\n            \"features\": features_df,\n            \"labeled_data\": df_labeled,\n            \"confirmed_count\": len(confirmed)\n        }\n\n\ndef main():\n    \"\"\"主函数\"\"\"\n    print(\"\\n\" + \"#\"*60)\n    print(\"# HuggingFace K线数据 + 反轉检测完整管道\")\n    print(\"#\"*60)\n    \n    # 步骤 1: 下载数据\n    print(\"\\n步骤 1: 从HuggingFace下载K线数据\")\n    print(\"-\"*60)\n    \n    downloader = HFKlinesDownloader()\n    downloader.install_packages()\n    \n    # 互动式选择或直接使用默认\n    interactive = input(\"\\n是否互动式选择数据? (y/n, 默认 n): \").strip().lower() == \"y\"\n    \n    if interactive:\n        df = downloader.interactive_download()\n    else:\n        print(\"使用默认数据: BTCUSDT 15分钟\")\n        df = downloader.download_klines(\"BTCUSDT\", \"15m\", 10000)\n    \n    if df is None:\n        print(\"\\n数据下载失败，程序退出\")\n        return\n    \n    print(f\"\\n下载完成: {len(df)} 行数据\")\n    print(f\"日期范围: {df['timestamp'].iloc[0]} 至 {df['timestamp'].iloc[-1]}\")\n    \n    # 步骤 2: 执行分析\n    print(\"\\n步骤 2: 执行反轉检测分析\")\n    print(\"-\"*60)\n    \n    analyzer = SwingReversalAnalyzer(\n        window=5,\n        future_candles=12,\n        threshold=1.0\n    )\n    \n    results = analyzer.analyze(df, output_prefix=\"hf_klines\")\n    \n    if results:\n        print(f\"\\n分析统认:\")\n        print(f\"  确认反轉点: {results['confirmed_count']}\")\n        if results['features'] is not None:\n            print(f\"  提取特征数: {len(results['features'])}\")\n    \n    print(\"\\n所有结果文件已生成\")\n\n\nif __name__ == \"__main__\":\n    main()\n